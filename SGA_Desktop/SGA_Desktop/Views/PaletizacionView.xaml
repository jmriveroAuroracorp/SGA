<Page x:Class="SGA_Desktop.Views.PaletizacionView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:helpers="clr-namespace:SGA_Desktop.Helpers"
      Background="{StaticResource BrushFondo}">

    <Page.Resources>
        <helpers:NullToBoolConverter x:Key="NotNullToBoolConverter"/>
        <helpers:BoolToYesNoConverter x:Key="BoolToYesNoConverter"/>
        <helpers:OperarioIdANombreConverter x:Key="OperarioIdANombreConverter"/>
        <helpers:EstaAbiertoConverter x:Key="EstaAbiertoConverter"/>
        <helpers:EstaCerradoConverter x:Key="EstaCerradoConverter"/>
        <helpers:EstadoColorConverter x:Key="EstadoColorConverter"/>
        <helpers:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
    </Page.Resources>

    <Grid Margin="8">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*" />
            <ColumnDefinition Width="5*" />
        </Grid.ColumnDefinitions>

        <!-- 📦 Palets -->
        <DockPanel Grid.Column="0" LastChildFill="True" Margin="0,0,8,0">
            <StackPanel Orientation="Horizontal"
                        DockPanel.Dock="Top"
                        Margin="0,0,0,8"
                        VerticalAlignment="Center">

                <Button Content="🔍 Filtros"
                        Style="{StaticResource EstiloBotonPrincipal}"
                        Command="{Binding AbrirFiltrosCommand}"
                        Width="110"
                        Margin="0,0,8,0"/>
                <Button Content="➕ Nuevo"
                        Style="{StaticResource EstiloBotonPrincipal}"
                        Command="{Binding CrearPaletCommand}"
                        Width="100"
                        Margin="0,0,8,0"/>
            </StackPanel>
            <ListView ItemsSource="{Binding PaletsView}"
          SelectedItem="{Binding PaletSeleccionado, Mode=TwoWay}"
          Margin="10"
          HorizontalContentAlignment="Stretch">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <Border Style="{StaticResource EstiloTarjeta}" Margin="4" Padding="8">
                            <StackPanel>
                                <!-- Código + Estado -->
                                <TextBlock Margin="0,0,0,4">
        <Run Text="{Binding Codigo}" FontWeight="Bold" FontSize="16" Foreground="{StaticResource BrushPrincipal}" />
        <Run Text=" - " />
        <Run Text="{Binding Estado}" Foreground="{Binding Estado, Converter={StaticResource EstadoColorConverter}}" FontSize="16"/>
                                </TextBlock>

                                <!-- Apertura + Abre -->
                                <TextBlock Margin="0,2,0,0">
        <Run Text="Apertura: " FontWeight="Bold"/>
        <Run Text="{Binding FechaApertura, StringFormat={}{0:dd/MM/yyyy}}"/>
        <Run Text=" - Abre: " FontWeight="Bold" />
        <Run Text="{Binding UsuarioAperturaNombre}"/>
                                </TextBlock>

                                <!-- Cierre + Cierra -->
                                <TextBlock Margin="0,2,0,0"
                                           Visibility="{Binding UsuarioCierreNombre, Converter={StaticResource NullToVisibilityConverter}}">
        <Run Text="Cierre: " FontWeight="Bold"/>
        <Run Text="{Binding FechaCierre, StringFormat={}{0:dd/MM/yyyy}}"/>
        <Run Text=" - Cierra: " FontWeight="Bold" />
        <Run Text="{Binding UsuarioCierreNombre}"/>
                                </TextBlock>

                                <!-- Orden de trabajo -->
                                <TextBlock Margin="0,2,0,0"
           Visibility="{Binding OrdenTrabajoId, Converter={StaticResource NullToVisibilityConverter}}">
      <Run Text="📄 " />
    <Run Text="Orden trabajo: " FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}" />
    <Run Text="{Binding OrdenTrabajoId}" Foreground="Black"/>
                                </TextBlock>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </DockPanel>
        <!-- 📋 Líneas + acciones -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0"
                       Text="{Binding PaletSeleccionado.Codigo, StringFormat=Contenido del palet: {0}}"
                       Style="{StaticResource LabelStyle}"
                       FontSize="16"
                       Margin="0,0,0,8"/>

            <ListView Grid.Row="1"
          SelectedItem="{Binding LineaSeleccionada, Mode=TwoWay}"
          ItemsSource="{Binding LineasPalet}"
          ScrollViewer.VerticalScrollBarVisibility="Auto">

                <ListView.Resources>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Margin" Value="0,0,0,10"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListViewItem">
                                    <Border x:Name="Bd"
                                Background="White"
                                CornerRadius="6"
                                BorderThickness="1"
                                BorderBrush="#007ACC"
                                Padding="10">
                                        <ContentPresenter />
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="Bd" Property="Background" Value="#f0f8ff"/>
                                        </Trigger>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="Bd" Property="Background" Value="#007ACC"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListView.Resources>

                <ListView.ItemTemplate>
                    <DataTemplate>
                        <Grid Margin="4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Izquierda: detalles -->
                            <StackPanel Grid.Column="0">

                                <!-- Código + Descripción -->
                                <TextBlock FontSize="16" FontWeight="Bold">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Foreground" Value="{StaticResource BrushPrincipal}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=IsSelected}" Value="True">
                                                    <Setter Property="Foreground" Value="White"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                        <Run Text="{Binding CodigoArticulo}" />
                        <Run Text=" - " />
                        <Run Text="{Binding DescripcionArticulo}" />
                                </TextBlock>

                                <!-- Almacén -->
                                <StackPanel Orientation="Horizontal">
                                    <!-- Etiqueta -->
                                    <TextBlock FontWeight="Bold">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="{StaticResource BrushIntermedio}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=IsSelected}" Value="True">
                                                        <Setter Property="Foreground" Value="White"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                        Almacén:
                                    </TextBlock>

                                    <!-- Valor -->
                                    <TextBlock Margin="4,0,0,0">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="Black"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=IsSelected}" Value="True">
                                                        <Setter Property="Foreground" Value="White"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                        <TextBlock.Text>
                                            <Binding Path="CodigoAlmacen"/>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>


                                <!-- Ubicación -->
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock FontWeight="Bold">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="{StaticResource BrushIntermedio}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=IsSelected}" Value="True">
                                                        <Setter Property="Foreground" Value="White"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
        Ubicación:
                                    </TextBlock>

                                    <TextBlock Margin="4,0,0,0">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="Black"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=IsSelected}" Value="True">
                                                        <Setter Property="Foreground" Value="White"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                        <TextBlock.Text>
                                            <Binding Path="Ubicacion"/>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>

                                <!-- Lote -->
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock FontWeight="Bold">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="{StaticResource BrushIntermedio}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=IsSelected}" Value="True">
                                                        <Setter Property="Foreground" Value="White"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
        Lote:
                                    </TextBlock>

                                    <TextBlock Margin="4,0,0,0">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="Black"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=IsSelected}" Value="True">
                                                        <Setter Property="Foreground" Value="White"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                        <TextBlock.Text>
                                            <Binding Path="Lote"/>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>

                                <!-- Caducidad -->
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock FontWeight="Bold">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="{StaticResource BrushIntermedio}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=IsSelected}" Value="True">
                                                        <Setter Property="Foreground" Value="White"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
        Caducidad:
                                    </TextBlock>

                                    <TextBlock Margin="4,0,0,0">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="Black"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=IsSelected}" Value="True">
                                                        <Setter Property="Foreground" Value="White"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                        <TextBlock.Text>
                                            <Binding Path="FechaCaducidad" StringFormat="{}{0:dd/MM/yyyy}"/>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>
                            </StackPanel>

                            <!-- Derecha: cantidad -->
                            <TextBlock Grid.Column="1"
                           Text="{Binding Cantidad}"
                           FontSize="24"
                           FontWeight="Bold"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Right"
                           Margin="20,0,0,0">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Foreground" Value="Black"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=IsSelected}" Value="True">
                                                <Setter Property="Foreground" Value="White"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>



            <StackPanel Grid.Row="2"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Margin="0,8,0,0">

                <!-- Acciones de palet -->
                
                <Button Content="📦 Añadir stock"
                        Margin="0,0,20,0"
                        Style="{StaticResource EstiloBotonPrincipal}"
                        Command="{Binding AbrirPaletLineasCommand}"
                        IsEnabled="{Binding PaletSeleccionado.Estado, Converter={StaticResource EstaAbiertoConverter}}" />

                <Button Content="🗑 Eliminar línea"
                        Margin="0,0,20,0"
                        Style="{StaticResource EstiloBotonPrincipal}"
                        Command="{Binding EliminarLineaSeleccionadaCommand}"
                        IsEnabled="{Binding PaletSeleccionado.Estado, Converter={StaticResource EstaAbiertoConverter}}" />

                <Button Content="🔒 Cerrar"
                        Margin="0,0,360,0"
                        Style="{StaticResource EstiloBotonPrincipal}"
                        Command="{Binding CerrarPaletCommand}"
                        IsEnabled="{Binding PaletSeleccionado.Estado, Converter={StaticResource EstaAbiertoConverter}}" />

                <Button Content="🔓 Reabrir"
                        Margin="0,0,20,0"
                        Style="{StaticResource EstiloBotonPrincipal}"
                        Command="{Binding ReabrirPaletCommand}"
                        IsEnabled="{Binding PaletSeleccionado.Estado, Converter={StaticResource EstaCerradoConverter}}" />
                <!-- Acciones de línea -->
                <Button Content="🖨 Imprimir"
                        Margin="0,0,20,0"
                        Style="{StaticResource EstiloBotonPrincipal}"
                        Command="{Binding ImprimirPaletCommand}" />
            </StackPanel>

            <TextBlock Text="{Binding ErrorMessage}"
                       Foreground="Red"
                       Margin="0,4"
                       FontWeight="Bold"/>
        </Grid>
    </Grid>
</Page>
