<Page x:Class="SGA_Desktop.Views.ConsultaStockView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:vm="clr-namespace:SGA_Desktop.ViewModels"
      mc:Ignorable="d"
      Background="{StaticResource BrushFondo}">

    <Page.DataContext>
        <vm:ConsultaStockViewModel />
    </Page.DataContext>

    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
    </Page.Resources>

    <Grid Margin="0" Cursor="">
        <Grid.RowDefinitions>
            <!-- 0: RadioButtons de modo -->
            <RowDefinition Height="Auto" />
            <!-- 1: Filtros -->
            <RowDefinition Height="Auto" />
            <!-- 2: Artículo destacado -->
            <RowDefinition Height="Auto" />
            <!-- 3: Resultados -->
            <RowDefinition Height="*" />
            <!-- 4: Botón Exportar -->
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- MODO DE BÚSQUEDA -->
        <StackPanel Grid.Row="0"
                    Orientation="Horizontal"
                    Margin="20,10"
                    HorizontalAlignment="Left">
            <TextBlock Text="Modo de Búsqueda"
               FontFamily="{StaticResource FuentePrincipal}"
               FontSize="16"
               FontWeight="Bold"
               VerticalAlignment="Center"
                       Foreground="{StaticResource BrushPrincipal}"
                       Margin="0,0,30,0"/>
            <RadioButton Content="Por Artículo"
                         FontWeight="Bold"
                         FontFamily="{StaticResource FuentePrincipal}"
             GroupName="Mode"
             Style="{StaticResource FancyRadioButton}"
             IsChecked="{Binding IsArticleMode}" 
                         Margin="0,0,40,0"/>

            <RadioButton Content="Por Ubicación"
                            FontWeight="Bold"
   FontFamily="{StaticResource FuentePrincipal}"
             GroupName="Mode"
             Style="{StaticResource FancyRadioButton}"
             IsChecked="{Binding IsLocationMode}"/>
        </StackPanel>

        <Grid Grid.Row="1" Margin="20,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <!-- Filtros -->
                <ColumnDefinition Width="Auto" />
                <!-- Botones -->
            </Grid.ColumnDefinitions>

            <!-- 🔍 Filtros a la izquierda -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Bottom">
                <!-- Filtros por artículo -->
                <StackPanel Orientation="Horizontal" Margin="0,0,20,0"
                    Visibility="{Binding ArticleFiltersVisibility}">
                    <!-- Artículo -->
                    <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                        <TextBlock Text="Artículo" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBox Width="150"
                         Style="{StaticResource EstiloCajaTexto}"
                         Text="{Binding FiltroArticulo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>

                    <!-- Partida -->
                    <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                        <TextBlock Text="Partida" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBox Width="120"
                         Style="{StaticResource EstiloCajaTexto}"
                         Text="{Binding FiltroPartida, Mode=TwoWay}"
                         IsEnabled="{Binding CanEnableInputs}"/>
                    </StackPanel>

                    <!-- Almacén -->
                    <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                        <TextBlock Text="Almacén" FontWeight="Bold" Margin="0,0,0,4"/>
                        <ComboBox Width="250"
                          Style="{StaticResource EstiloComboBox}"
                          ItemsSource="{Binding AlmacenesCombo}"
                          DisplayMemberPath="DescripcionCombo"
                          SelectedItem="{Binding AlmacenSeleccionadoCombo, Mode=TwoWay}"
                          IsEnabled="{Binding CanEnableInputs}"/>
                    </StackPanel>

                    <!-- Ubicación -->
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="Ubicación" FontWeight="Bold" Margin="0,0,0,4"/>
                        <ComboBox Width="120"
                          Style="{StaticResource EstiloComboBox}"
                          ItemsSource="{Binding Ubicaciones}"
                          SelectedItem="{Binding FiltroUbicacion, Mode=TwoWay}"
                          IsEnabled="{Binding CanEnableInputs}"
                          MaxDropDownHeight="200"/>
                    </StackPanel>

                    <!-- Combo de Artículos únicos (solo tras búsqueda por descripción) -->
                    <!--<StackPanel Orientation="Vertical"
                    Visibility="{Binding ArticulosUnicosVisibility}">
                        <TextBlock Text="Selecciona artículo" FontWeight="Bold" Margin="0,0,0,4"/>
                        <ComboBox Width="250"
                      Style="{StaticResource EstiloComboBox}"
                      ItemsSource="{Binding ArticulosUnicos}"
                      SelectedItem="{Binding ArticuloSeleccionado, Mode=TwoWay}"
                      DisplayMemberPath="Display"
                      IsEditable="False"/>
                    </StackPanel>-->
                </StackPanel>

                <!-- Filtros por ubicación -->
                <StackPanel Orientation="Horizontal" Visibility="{Binding LocationFiltersVisibility}">
                    <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                        <TextBlock Text="Almacén" FontWeight="Bold" Margin="0,0,0,4"/>
                        <ComboBox Width="250"
                         Style="{StaticResource EstiloComboBox}"
                         ItemsSource="{Binding AlmacenesCombo}"
                         DisplayMemberPath="DescripcionCombo"
                         SelectedItem="{Binding AlmacenSeleccionadoCombo, Mode=TwoWay}"/>
                    </StackPanel>

                    <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                        <TextBlock Text="Ubicación" FontWeight="Bold" Margin="0,0,0,4"/>
                        <ComboBox Width="120"
                          Style="{StaticResource EstiloComboBox}"
                          ItemsSource="{Binding Ubicaciones}"
                          SelectedItem="{Binding FiltroUbicacion, Mode=TwoWay}"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>

            <!-- ✅ Botones a la derecha -->
            <StackPanel Grid.Column="1"
                Orientation="Horizontal"
                VerticalAlignment="Bottom"
                HorizontalAlignment="Right"
                Margin="20,0,0,0">
                <Button Content="Buscar"
                Style="{StaticResource EstiloBotonPrincipal}"
                Width="120" Height="36"
                Command="{Binding BuscarCommand}"
                Margin="0,0,12,0"/>

                <Button Content="Limpiar filtros"
                Style="{StaticResource EstiloBotonPrincipal}"
                Width="120" Height="36"
                Command="{Binding LimpiarFiltrosCommand}"/>
            </StackPanel>
        </Grid>


        <!-- FILA 2: artículo destacado / combo -->
        <StackPanel Grid.Row="2"
            Orientation="Vertical"
            Margin="20,0,20,10"
            Visibility="{Binding IsArticleMode, Converter={StaticResource BoolToVis}}">

            <!-- 1) Artículo destacado (solo en búsquedas por código) -->
            <TextBlock Text="{Binding ArticuloMostrado}"
               FontFamily="{StaticResource FuentePrincipal}"
               FontSize="28"
               FontWeight="Bold"
               Foreground="{StaticResource BrushPrincipal}"
               Visibility="{Binding ListViewVisibility}" />

            <!-- 2) Combo para elegir artículo (solo en búsquedas por descripción) -->
            <StackPanel Orientation="Horizontal"
                Margin="0,8,0,0"
                Visibility="{Binding ArticulosUnicosVisibility}">
                <TextBlock Text="Selecciona artículo"
                   FontWeight="Bold"
                   VerticalAlignment="Center"
                   Margin="0,0,8,0"/>
                <ComboBox Width="300"
                  Style="{StaticResource EstiloComboBox}"
                  ItemsSource="{Binding ArticulosUnicos}"
                  SelectedItem="{Binding ArticuloSeleccionado, Mode=TwoWay}"
                  DisplayMemberPath="Display"
                  IsEditable="False"/>
            </StackPanel>
        </StackPanel>



        <!-- RESULTADOS: MODO POR ARTÍCULO -->
        <ListView Grid.Row="3"
          ItemsSource="{Binding StockFiltrado}"
          Visibility="{Binding ListViewVisibility}"
          SelectionMode="Single"
          ScrollViewer.VerticalScrollBarVisibility="Auto">

            <ListView.Resources>
                <!-- Estilo de cada tarjeta -->
                <Style TargetType="ListViewItem">
                    <Setter Property="FontFamily" Value="{StaticResource FuentePrincipal}"/>
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    <Setter Property="MinHeight" Value="80"/>
                    <Setter Property="Margin" Value="0,0,0,10"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Foreground" Value="Black"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListViewItem">
                                <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="6"
                                BorderThickness="1"
                                BorderBrush="{StaticResource BrushPrincipal}">
                                    <ContentPresenter />
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="Bd" Property="Background" Value="#10CCCCCC"/>
                                    </Trigger>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter TargetName="Bd" Property="Background" Value="{StaticResource BrushSecundario1}"/>
                                        <Setter Property="Foreground" Value="White"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListView.Resources>

            <ListView.ItemTemplate>
                <DataTemplate>
                    <Grid Margin="8">
                        <Grid.ColumnDefinitions>
                            <!-- Código -->
                            <ColumnDefinition Width="180"/>
                            <!-- Artículo + Almacén -->
                            <ColumnDefinition Width="2*"/>
                            <!-- Ubicación + Partida + Fecha -->
                            <ColumnDefinition Width="2*"/>
                            <!-- Saldo -->
                            <ColumnDefinition Width="80"/>
                        </Grid.ColumnDefinitions>

                        <!-- 1) Código -->
                        <TextBlock Grid.Column="0"
                           Text="{Binding CodigoArticulo}"
                           FontWeight="Bold"
                           FontSize="20"
                           Foreground="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=Foreground}"
                           VerticalAlignment="Center"
                           TextAlignment="Center"/>

                        <!-- 2) Artículo y almacén -->
                        <StackPanel Grid.Column="1"
                            VerticalAlignment="Center">
                            <TextBlock Text="{Binding DescripcionArticulo}"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Foreground="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=Foreground}"/>
                            <TextBlock>
                        <Run Text="{Binding CodigoAlmacen}"/>
                        <Run Text=" – "/>
                        <Run Text="{Binding Almacen}"/>
                            </TextBlock>
                        </StackPanel>

                        <!-- 3) Ubicación / Partida / Caducidad -->
                        <StackPanel Grid.Column="2" VerticalAlignment="Center">
                            <TextBlock Text="{Binding Ubicacion, StringFormat='Ubicación: {0}'}"
                               FontSize="14"
                               Foreground="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=Foreground}"/>
                            <TextBlock Text="{Binding Partida, StringFormat='Partida: {0}'}"
                               FontSize="14"
                               Foreground="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=Foreground}"/>
                            <TextBlock Text="{Binding FechaCaducidad, StringFormat='Cad.: {0:d}'}"
                               FontSize="14"
                               Foreground="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=Foreground}"/>
                        </StackPanel>

                        <!-- 4) Saldo -->
                        <TextBlock Grid.Column="3"
                           Text="{Binding UnidadSaldo, StringFormat=N2}"
                           FontSize="16"
                           FontWeight="Bold"
                           Foreground="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=Foreground}"
                           VerticalAlignment="Center"
                           TextAlignment="Right"/>
                    </Grid>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>

        <!-- RESULTADOS: MODO POR UBICACIÓN -->
        <ListView Grid.Row="3"
          ItemsSource="{Binding ResultadosStockPorUbicacion}"
          Visibility="{Binding IsLocationMode, Converter={StaticResource BoolToVis}}"
          SelectionMode="Single"
          ScrollViewer.VerticalScrollBarVisibility="Auto">

            <!-- 1) Estilo de tarjeta idéntico -->
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="FontFamily" Value="{StaticResource FuentePrincipal}"/>
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    <Setter Property="MinHeight" Value="80"/>
                    <Setter Property="Margin" Value="0,0,0,10"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Foreground" Value="Black"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListViewItem">
                                <Border x:Name="Bd"
                    Background="{TemplateBinding Background}"
                    CornerRadius="6"
                    BorderThickness="1"
                    BorderBrush="{StaticResource BrushPrincipal}">
                                    <ContentPresenter />
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="Bd" Property="Background" Value="#10CCCCCC"/>
                                    </Trigger>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter TargetName="Bd" Property="Background" Value="{StaticResource BrushSecundario1}"/>
                                        <Setter Property="Foreground" Value="White"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListView.ItemContainerStyle>

            <!-- 2) Template de tarjeta replicado -->
            <ListView.ItemTemplate>
                <DataTemplate>
                    <Grid Margin="8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="180"/>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="80"/>
                        </Grid.ColumnDefinitions>

                        <!-- 2.1 Código Artículo -->
                        <TextBlock Grid.Column="0"
                   Text="{Binding CodigoArticulo}"
                   FontWeight="Bold"
                   FontSize="20"
                   Foreground="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=Foreground}"
                   VerticalAlignment="Center"
                   TextAlignment="Center"/>

                        <!-- 2) Artículo y almacén -->
                        <StackPanel Grid.Column="1"
      VerticalAlignment="Center">
                            <TextBlock Text="{Binding DescripcionArticulo}"
         FontSize="16"
         FontWeight="SemiBold"
         Foreground="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=Foreground}"/>
                            <TextBlock>
  <Run Text="{Binding CodigoAlmacen}"/>
  <Run Text=" – "/>
  <Run Text="{Binding Almacen}"/>
                            </TextBlock>
                        </StackPanel>

                        <!-- 3) Ubicación / Partida / Caducidad -->
                        <StackPanel Grid.Column="2" VerticalAlignment="Center">
                            <TextBlock Text="{Binding Ubicacion, StringFormat='Ubicación: {0}'}"
        FontSize="14"
        Foreground="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=Foreground}"/>
                            <TextBlock Text="{Binding Partida, StringFormat='Partida: {0}'}"
        FontSize="14"
        Foreground="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=Foreground}"/>
                            <TextBlock Text="{Binding FechaCaducidad, StringFormat='Cad.: {0:d}'}"
        FontSize="14"
        Foreground="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=Foreground}"/>
                        </StackPanel>

                        <!-- 2.5 Saldo -->
                        <TextBlock Grid.Column="3"
                   Text="{Binding UnidadSaldo, StringFormat=N2}"
                   FontSize="16"
                   FontWeight="Bold"
                   VerticalAlignment="Center"
                   TextAlignment="Right"
                   Margin="8,0,0,0"
                   Foreground="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=Foreground}"/>
                    </Grid>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>




        <!-- AÑADIMOS LA FILA 4: Exportar Excel ABAJO A LA DERECHA -->
        <StackPanel Grid.Row="4"
                Orientation="Horizontal"
                HorizontalAlignment="Right"
                Margin="20,10,20,20">
            <Button Content="Exportar Excel"
            Style="{StaticResource EstiloBotonPrincipal}"
            Width="120"
            Height="30"
            Command="{Binding ExportarExcelCommand}"/>
        </StackPanel>
    </Grid>
</Page>
