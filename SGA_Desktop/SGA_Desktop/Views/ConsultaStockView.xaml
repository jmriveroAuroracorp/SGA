<Page x:Class="SGA_Desktop.Views.ConsultaStockView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:vm="clr-namespace:SGA_Desktop.ViewModels"
      xmlns:helpers="clr-namespace:SGA_Desktop.Helpers"
      mc:Ignorable="d"
      Background="{StaticResource BrushFondo}">

    <Page.DataContext>
        <vm:ConsultaStockViewModel />
    </Page.DataContext>

    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <helpers:NullOrEmptyToVisibilityConverter x:Key="NullOrEmptyToVisibility"/>
        <helpers:PaletsCountToVisibilityConverter x:Key="PaletsCountToVisibility"/>
        <helpers:NegativeValueColorConverter x:Key="NegativeValueColorConverter"/>
        <helpers:BindingProxy x:Key="VmProxy" Data="{Binding}" />
    </Page.Resources>

    <Grid Margin="0" Cursor="">
        <Grid.RowDefinitions>
            <!-- 0: RadioButtons de modo -->
            <RowDefinition Height="Auto" />
            <!-- 1: Filtros -->
            <RowDefinition Height="Auto" />
            <!-- 2: Artículo destacado -->
            <RowDefinition Height="Auto" />
            <!-- 3: Resultados -->
            <RowDefinition Height="*" />
            <!-- 4: Botón Exportar -->
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- MODO DE BÚSQUEDA -->
        <StackPanel Grid.Row="0"
                    Orientation="Horizontal"
                    Margin="20,10"
                    HorizontalAlignment="Left">
            <TextBlock Text="Modo de Búsqueda"
               FontFamily="{StaticResource FuentePrincipal}"
               FontSize="16"
               FontWeight="Bold"
               VerticalAlignment="Center"
                       Foreground="{StaticResource BrushPrincipal}"
                       Margin="0,0,30,0"/>
            <RadioButton Content="Por Artículo"
                         FontWeight="Bold"
                         FontFamily="{StaticResource FuentePrincipal}"
             GroupName="Mode"
             Style="{StaticResource FancyRadioButton}"
             IsChecked="{Binding IsArticleMode}" 
                         Margin="0,0,40,0"/>

            <RadioButton Content="Por Ubicación"
                            FontWeight="Bold"
   FontFamily="{StaticResource FuentePrincipal}"
             GroupName="Mode"
             Style="{StaticResource FancyRadioButton}"
             IsChecked="{Binding IsLocationMode}"/>
        </StackPanel>

        <Grid Grid.Row="1" Margin="20,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <!-- Filtros -->
                <ColumnDefinition Width="Auto" />
                <!-- Botones -->
            </Grid.ColumnDefinitions>

            <!-- 🔍 Filtros a la izquierda -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Bottom">
                <!-- Filtros por artículo -->
                <StackPanel Orientation="Horizontal" Margin="0,0,20,0"
                    Visibility="{Binding ArticleFiltersVisibility}">
                    <!-- Artículo -->
                    <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                        <TextBlock Text="Artículo" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBox Width="150"
                         Style="{StaticResource EstiloCajaTexto}"
                         Text="{Binding FiltroArticulo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         KeyDown="TextBox_KeyDown"/>
                    </StackPanel>

                    <!-- Partida -->
                    <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                        <TextBlock Text="Partida" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBox Width="120"
                         Style="{StaticResource EstiloCajaTexto}"
                         Text="{Binding FiltroPartida, Mode=TwoWay}"
                         IsEnabled="{Binding CanEnableInputs}"
                         KeyDown="TextBox_KeyDown"/>
                    </StackPanel>

                    <!-- Almacén -->
                    <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                        <TextBlock Text="Almacén" FontWeight="Bold" Margin="0,0,0,4"/>
                        <ComboBox Width="250"
                          ItemsSource="{Binding AlmacenesCombo}"
                          DisplayMemberPath="DescripcionCombo"
                          SelectedItem="{Binding AlmacenSeleccionadoCombo, Mode=TwoWay}"
                          IsEnabled="{Binding CanEnableInputs}"
                          IsEditable="True"
                          IsTextSearchEnabled="True"
                          Height="28"
                          FontSize="14"
                          Padding="6,2"/>
                    </StackPanel>

                    <!-- Ubicación -->
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="Ubicación" FontWeight="Bold" Margin="0,0,0,4"/>
                        <ComboBox Width="120"
                          Style="{StaticResource EstiloComboBox}"
                          ItemsSource="{Binding Ubicaciones}"
                          SelectedItem="{Binding FiltroUbicacion, Mode=TwoWay}"
                          IsEnabled="{Binding CanEnableInputs}"
                          MaxDropDownHeight="200"/>
                    </StackPanel>

                    <!-- Combo de Artículos únicos (solo tras búsqueda por descripción) -->
                    <!--<StackPanel Orientation="Vertical"
                    Visibility="{Binding ArticulosUnicosVisibility}">
                        <TextBlock Text="Selecciona artículo" FontWeight="Bold" Margin="0,0,0,4"/>
                        <ComboBox Width="250"
                      Style="{StaticResource EstiloComboBox}"
                      ItemsSource="{Binding ArticulosUnicos}"
                      SelectedItem="{Binding ArticuloSeleccionado, Mode=TwoWay}"
                      DisplayMemberPath="Display"
                      IsEditable="False"/>
                    </StackPanel>-->
                </StackPanel>

                <!-- Filtros por ubicación -->
                <StackPanel Orientation="Horizontal" Visibility="{Binding LocationFiltersVisibility}">
                    <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                        <TextBlock Text="Almacén" FontWeight="Bold" Margin="0,0,0,4"/>
                        <ComboBox Width="250"
                         ItemsSource="{Binding AlmacenesCombo}"
                         DisplayMemberPath="DescripcionCombo"
                         SelectedItem="{Binding AlmacenSeleccionadoCombo, Mode=TwoWay}"
                         IsEditable="True"
                         IsTextSearchEnabled="True"
                         Height="28"
                         FontSize="14"
                         Padding="6,2"/>
                    </StackPanel>

                    <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                        <TextBlock Text="Ubicación" FontWeight="Bold" Margin="0,0,0,4"/>
                        <ComboBox Width="120"
                          Style="{StaticResource EstiloComboBox}"
                          ItemsSource="{Binding Ubicaciones}"
                          SelectedItem="{Binding FiltroUbicacion, Mode=TwoWay}"
                          KeyDown="TextBox_KeyDown"/>
                    </StackPanel>
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="Buscar" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBox Width="250"
                                 Height="40"
                         Margin="0,0,0,0"
                         Text="{Binding FiltroBusqueda, UpdateSourceTrigger=PropertyChanged}"
                         ToolTip="Buscar por código o descripción"
                          Style="{StaticResource EstiloCajaTexto}"
                         KeyDown="TextBox_KeyDown"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>

            <!-- ✅ Botones a la derecha -->
            <StackPanel Grid.Column="1"
                Orientation="Horizontal"
                VerticalAlignment="Bottom"
                HorizontalAlignment="Right"
                Margin="20,0,0,0">
                <Button Content="Buscar"
                Style="{StaticResource EstiloBotonPrincipal}"
                Width="120" Height="36"
                Command="{Binding BuscarCommand}"
                Margin="0,0,12,0"/>

                <Button Content="Limpiar filtros"
                Style="{StaticResource EstiloBotonPrincipal}"
                Width="120" Height="36"
                Command="{Binding LimpiarFiltrosCommand}"
                IsEnabled="{Binding CanClearFilters}"
                Margin="0,0,12,0"/>

                <Button Content="Refrescar"
                Style="{StaticResource EstiloBotonPrincipal}"
                Width="120" Height="36"
                Command="{Binding RefrescarCommand}"
                IsEnabled="{Binding CanRefresh}"/>

            </StackPanel>
        </Grid>


        <!-- FILA 2: artículo destacado / combo -->
        <StackPanel Grid.Row="2"
            Orientation="Vertical"
            Margin="20,0,20,10"
            Visibility="{Binding IsArticleMode, Converter={StaticResource BoolToVis}}">

            <!-- 1) Artículo destacado (solo en búsquedas por código) -->
            <TextBlock Text="{Binding ArticuloMostrado}"
               FontFamily="{StaticResource FuentePrincipal}"
               FontSize="28"
               FontWeight="Bold"
               Foreground="{StaticResource BrushPrincipal}"
               Visibility="{Binding ListViewVisibility}" />

            <!-- 2) Combo para elegir artículo (solo en búsquedas por descripción) -->
            <StackPanel Orientation="Horizontal"
                Margin="0,8,0,0"
                Visibility="{Binding ArticulosUnicosVisibility}">
                <TextBlock Text="Selecciona artículo"
                   FontWeight="Bold"
                   VerticalAlignment="Center"
                   Margin="0,0,8,0"/>
                <ComboBox Width="300"
                  Style="{StaticResource EstiloComboBox}"
                  ItemsSource="{Binding ArticulosUnicos}"
                  SelectedItem="{Binding ArticuloSeleccionado, Mode=TwoWay}"
                  DisplayMemberPath="Display"
                  IsEditable="False"/>
            </StackPanel>
        </StackPanel>


        <!-- RESULTADOS: MODO POR ARTÍCULO -->
        <ListView Grid.Row="3"
          ItemsSource="{Binding StockFiltrado}"
          SelectedItem="{Binding ArticuloSeleccionadoParaImprimir, Mode=TwoWay}"
          Visibility="{Binding ListViewVisibility}"
          SelectionMode="Single"
          ScrollViewer.VerticalScrollBarVisibility="Auto">

            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="FontFamily" Value="{StaticResource FuentePrincipal}"/>
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    <Setter Property="Margin" Value="0,0,0,10"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Foreground" Value="Black"/>
                    <Setter Property="ContextMenu">
                        <Setter.Value>
                            <ContextMenu Style="{StaticResource EstiloContextMenu}">
                                <MenuItem Header="Copiar código"
            Style="{StaticResource EstiloMenuItem}"
            Command="{Binding Data.CopiarCodigoCommand, Source={StaticResource VmProxy}}"
            CommandParameter="{Binding CodigoArticulo}" />
                                <MenuItem Header="Copiar descripción"
Style="{StaticResource EstiloMenuItem}"
Command="{Binding Data.CopiarDescripcionCommand, Source={StaticResource VmProxy}}"
CommandParameter="{Binding DescripcionArticulo, TargetNullValue=''}"/>
                                <MenuItem Header="Copiar lote"
Style="{StaticResource EstiloMenuItem}"
Command="{Binding Data.CopiarLoteCommand, Source={StaticResource VmProxy}}"
CommandParameter="{Binding Partida, TargetNullValue=''}"/>
                                <MenuItem Header="Copiar fecha caducidad"
Style="{StaticResource EstiloMenuItem}"
Command="{Binding Data.CopiarFechaCaducidadCommand, Source={StaticResource VmProxy}}"
CommandParameter="{Binding FechaCaducidad}"/>
                            </ContextMenu>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListView.ItemContainerStyle>

            <ListView.ItemTemplate>
                <DataTemplate>
                    <Border x:Name="CardBorder"
                    CornerRadius="6"
                    BorderThickness="2"
                    BorderBrush="{StaticResource BrushPrincipal}"
                    Background="White"
                    Margin="0,0,0,10">

                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Background" Value="White"/>
                                <Setter Property="BorderBrush" Value="{StaticResource BrushPrincipal}"/>
                                <Style.Triggers>
                                    <!-- Hover -->
                                    <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=ListViewItem}}" Value="True">
                                        <Setter Property="Background" Value="#E6F0FA"/>
                                    </DataTrigger>
                                    <!-- Selección -->
                                    <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListViewItem}}" Value="True">
                                        <Setter Property="Background" Value="{StaticResource BrushSecundario1}"/>
                                        <Setter Property="BorderBrush" Value="{StaticResource BrushSecundario1}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>

                        <!-- 👇 Contenido -->
                        <Grid Margin="8,4">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="220"/>
                            </Grid.ColumnDefinitions>

                            <!-- FILA 1: Código, Descripción, Almacén, Ubicación, Lote, Caducidad -->
                            <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Horizontal">
                                <TextBlock Text="{Binding CodigoArticulo}"
                                   FontWeight="Bold"
                                   FontSize="18"
                                   Foreground="{StaticResource BrushPrincipal}"
                                   Margin="0,0,12,0"/>
                                <TextBlock Text="{Binding DescripcionArticulo}"
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   Margin="0,0,20,0"/>
                                <TextBlock Text="Almacén:" FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}"/>
                                <TextBlock Text="{Binding CodigoAlmacen}" Margin="2,0,12,0"/>
                                <TextBlock Text="Ubicación:" FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}"/>
                                <TextBlock Text="{Binding Ubicacion}" Margin="2,0,12,0"/>
                                <TextBlock Text="Lote:" FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}"/>
                                <TextBlock Text="{Binding Partida}" Margin="2,0,12,0"/>
                                <TextBlock Text="Caducidad:" FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}"/>
                                <TextBlock Text="{Binding FechaCaducidad, StringFormat=dd/MM/yyyy}" Margin="2,0,0,0"/>
                            </StackPanel>

                            <!-- FILA 2: Palets inline/expander + Totales -->
                            <StackPanel Grid.Row="1" Grid.Column="0" Orientation="Vertical" Margin="0,4,0,0">
                                <!-- Inline si solo hay un palet -->
                                <ItemsControl ItemsSource="{Binding Palets}"
                                      Visibility="{Binding Palets, Converter={StaticResource PaletsCountToVisibility}, ConverterParameter=One}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                <TextBlock Text="{Binding CodigoPalet}" FontWeight="Bold" Margin="0,0,6,0"/>
                                                <Ellipse Width="12" Height="12" Margin="0,0,6,0" VerticalAlignment="Center">
                                                    <Ellipse.Style>
                                                        <Style TargetType="Ellipse">
                                                            <Setter Property="Fill" Value="Gray"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding EstadoPalet}" Value="Cerrado">
                                                                    <Setter Property="Fill" Value="Red"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding EstadoPalet}" Value="Abierto">
                                                                    <Setter Property="Fill" Value="Green"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding EstadoPalet}" Value="Vaciado">
                                                                    <Setter Property="Fill" Value="Orange"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Ellipse.Style>
                                                </Ellipse>
                                                <TextBlock Text="{Binding Cantidad, StringFormat='Cantidad: {0:F4}'}" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <!-- Expander si hay más de un palet -->
                                <Expander Header="Palets en esta ubicación"
                                  IsExpanded="False"
                                  Margin="0,4,0,0"
                                  Visibility="{Binding Palets, Converter={StaticResource PaletsCountToVisibility}, ConverterParameter=Many}">
                                    <ItemsControl ItemsSource="{Binding Palets}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal" Margin="8,2">
                                                    <TextBlock Text="{Binding CodigoPalet}" FontWeight="Bold" Margin="0,0,6,0"/>
                                                    <Ellipse Width="12" Height="12" Margin="0,0,6,0" VerticalAlignment="Center">
                                                        <Ellipse.Style>
                                                            <Style TargetType="Ellipse">
                                                                <Setter Property="Fill" Value="Gray"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding EstadoPalet}" Value="Cerrado">
                                                                        <Setter Property="Fill" Value="Red"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding EstadoPalet}" Value="Abierto">
                                                                        <Setter Property="Fill" Value="Green"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding EstadoPalet}" Value="Vaciado">
                                                                        <Setter Property="Fill" Value="Orange"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Ellipse.Style>
                                                    </Ellipse>
                                                    <TextBlock Text="{Binding Cantidad, StringFormat='Cantidad: {0:F4}'}" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Expander>

                                <!-- Totales debajo -->
                                <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                    <TextBlock Text="Global:" FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}">
                                        <TextBlock.ToolTip>
                                            <ToolTip>
                                                <TextBlock>
                                                    <Run Text="Cantidad "/>
                                                    <Run Text="total" FontWeight="Bold"/>
                                                    <Run Text=" de "/>
                                                    <Run Text="este" FontWeight="Bold"/>
                                                    <Run Text=" artículo por lote y fecha de caducidad en "/>
                                                    <Run Text="todos" FontWeight="Bold"/>
                                                    <Run Text=" los almacenes"/>
                                                </TextBlock>
                                            </ToolTip>
                                        </TextBlock.ToolTip>
                                    </TextBlock>
                                    <TextBlock Text="{Binding TotalArticuloGlobal, StringFormat=F4}" Margin="4,0,12,0"/>
                                    <TextBlock Text="Almacén:" FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}">
                                        <TextBlock.ToolTip>
                                            <ToolTip>
                                                <TextBlock>
                                                    <Run Text="Cantidad "/>
                                                    <Run Text="total" FontWeight="Bold"/>
                                                    <Run Text=" de "/>
                                                    <Run Text="este" FontWeight="Bold"/>
                                                    <Run Text=" artículo por lote y fecha de caducidad en "/>
                                                    <Run Text="este" FontWeight="Bold"/>
                                                    <Run Text=" almacén específico"/>
                                                </TextBlock>
                                            </ToolTip>
                                        </TextBlock.ToolTip>
                                    </TextBlock>
                                    <TextBlock Text="{Binding TotalArticuloAlmacen, StringFormat=F4}" Margin="4,0,0,0"/>
                                </StackPanel>
                            </StackPanel>

                            <!-- A LA DERECHA: Disponible destacado -->
                            <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="1"
                            Background="#F0F6FF"
                            CornerRadius="6"
                            Padding="12,4"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Disponible:" 
                                       FontWeight="Bold" 
                                       Foreground="{StaticResource BrushPrincipal}" 
                                       FontSize="15"
                                       Margin="0,0,4,0"/>
                                    <TextBlock Text="{Binding UnidadSaldo, StringFormat=F4}"  
                                       FontWeight="Bold" 
                                       FontSize="22"
                                       Foreground="{Binding UnidadSaldo, Converter={StaticResource NegativeValueColorConverter}}"/>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>


        <!-- RESULTADOS: MODO POR UBICACIÓN -->
        <ListView Grid.Row="3"
          ItemsSource="{Binding ResultadosStockPorUbicacion}"
          SelectedItem="{Binding ArticuloSeleccionadoParaImprimir, Mode=TwoWay}"
          Visibility="{Binding IsLocationMode, Converter={StaticResource BoolToVis}}"
          SelectionMode="Single"
          ScrollViewer.VerticalScrollBarVisibility="Auto">

            <!-- Contenedor de ítems -->
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="FontFamily" Value="{StaticResource FuentePrincipal}"/>
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    <Setter Property="Margin" Value="0,0,0,10"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Foreground" Value="Black"/>
                    <Setter Property="ContextMenu">
                        <Setter.Value>
                            <ContextMenu Style="{StaticResource EstiloContextMenu}">
                                <MenuItem Header="Copiar código"
                      Style="{StaticResource EstiloMenuItem}"
                      Command="{Binding Data.CopiarCodigoCommand, Source={StaticResource VmProxy}}"
                      CommandParameter="{Binding CodigoArticulo}" />
                                <MenuItem Header="Copiar descripción"
          Style="{StaticResource EstiloMenuItem}"
          Command="{Binding Data.CopiarDescripcionCommand, Source={StaticResource VmProxy}}"
          CommandParameter="{Binding DescripcionArticulo, TargetNullValue=''}"/>
                                <MenuItem Header="Copiar lote"
          Style="{StaticResource EstiloMenuItem}"
          Command="{Binding Data.CopiarLoteCommand, Source={StaticResource VmProxy}}"
          CommandParameter="{Binding Partida, TargetNullValue=''}"/>
                                <MenuItem Header="Copiar fecha caducidad"
          Style="{StaticResource EstiloMenuItem}"
          Command="{Binding Data.CopiarFechaCaducidadCommand, Source={StaticResource VmProxy}}"
          CommandParameter="{Binding FechaCaducidad}"/>
                            </ContextMenu>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListView.ItemContainerStyle>


            <!-- Plantilla con inline o expander -->
            <ListView.ItemTemplate>
                <DataTemplate>
                    <Border x:Name="CardBorder"
                    CornerRadius="6"
                    BorderThickness="2"
                    BorderBrush="{StaticResource BrushPrincipal}"
                    Background="White"
                    Margin="0,0,0,10">

                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Background" Value="White"/>
                                <Setter Property="BorderBrush" Value="{StaticResource BrushPrincipal}"/>
                                <Style.Triggers>
                                    <!-- Hover -->
                                    <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=ListViewItem}}" Value="True">
                                        <Setter Property="Background" Value="#E6F0FA"/>
                                    </DataTrigger>
                                    <!-- Selección -->
                                    <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListViewItem}}" Value="True">
                                        <Setter Property="Background" Value="{StaticResource BrushSecundario1}"/>
                                        <Setter Property="BorderBrush" Value="{StaticResource BrushSecundario1}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>

                        <!-- 👇 Tu contenido -->
                        <Grid Margin="8,4">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="220"/>
                            </Grid.ColumnDefinitions>

                            <!-- FILA 1: Código, Descripción, Almacén, Ubicación, Lote, Caducidad -->
                            <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Horizontal">
                                <TextBlock Text="{Binding CodigoArticulo}"
                                   FontWeight="Bold"
                                   FontSize="18"
                                   Foreground="{StaticResource BrushPrincipal}"
                                   Margin="0,0,12,0"/>
                                <TextBlock Text="{Binding DescripcionArticulo}"
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   Margin="0,0,20,0"/>
                                <TextBlock Text="Almacén:" FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}"/>
                                <TextBlock Text="{Binding CodigoAlmacen}" Margin="2,0,12,0"/>
                                <TextBlock Text="Ubicación:" FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}"/>
                                <TextBlock Text="{Binding Ubicacion}" Margin="2,0,12,0"/>
                                <TextBlock Text="Lote:" FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}"/>
                                <TextBlock Text="{Binding Partida}" Margin="2,0,12,0"/>
                                <TextBlock Text="Caducidad:" FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}"/>
                                <TextBlock Text="{Binding FechaCaducidad, StringFormat=dd/MM/yyyy}" Margin="2,0,0,0"/>
                            </StackPanel>

                            <!-- FILA 2: Palets inline/expander + Totales -->
                            <StackPanel Grid.Row="1" Grid.Column="0" Orientation="Vertical" Margin="0,4,0,0">
                                <!-- Inline si solo hay un palet -->
                                <ItemsControl ItemsSource="{Binding Palets}"
                                      Visibility="{Binding Palets, Converter={StaticResource PaletsCountToVisibility}, ConverterParameter=One}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                <TextBlock Text="{Binding CodigoPalet}" FontWeight="Bold" Margin="0,0,6,0"/>
                                                <Ellipse Width="12" Height="12" Margin="0,0,6,0" VerticalAlignment="Center">
                                                    <Ellipse.Style>
                                                        <Style TargetType="Ellipse">
                                                            <Setter Property="Fill" Value="Gray"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding EstadoPalet}" Value="Cerrado">
                                                                    <Setter Property="Fill" Value="Red"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding EstadoPalet}" Value="Abierto">
                                                                    <Setter Property="Fill" Value="Green"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding EstadoPalet}" Value="Vaciado">
                                                                    <Setter Property="Fill" Value="Orange"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Ellipse.Style>
                                                </Ellipse>
                                                <TextBlock Text="{Binding Cantidad, StringFormat='Cantidad: {0:F4}'}" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <!-- Expander si hay más de un palet -->
                                <Expander Header="Palets en esta ubicación"
                                  IsExpanded="False"
                                  Margin="0,4,0,0"
                                  Visibility="{Binding Palets, Converter={StaticResource PaletsCountToVisibility}, ConverterParameter=Many}">
                                    <ItemsControl ItemsSource="{Binding Palets}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal" Margin="8,2">
                                                    <TextBlock Text="{Binding CodigoPalet}" FontWeight="Bold" Margin="0,0,6,0"/>
                                                    <Ellipse Width="12" Height="12" Margin="0,0,6,0" VerticalAlignment="Center">
                                                        <Ellipse.Style>
                                                            <Style TargetType="Ellipse">
                                                                <Setter Property="Fill" Value="Gray"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding EstadoPalet}" Value="Cerrado">
                                                                        <Setter Property="Fill" Value="Red"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding EstadoPalet}" Value="Abierto">
                                                                        <Setter Property="Fill" Value="Green"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding EstadoPalet}" Value="Vaciado">
                                                                        <Setter Property="Fill" Value="Orange"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Ellipse.Style>
                                                    </Ellipse>
                                                    <TextBlock Text="{Binding Cantidad, StringFormat='Cantidad: {0:F4}'}" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Expander>

                                <!-- Totales debajo -->
                                <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                    <TextBlock Text="Global:" FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}">
                                        <TextBlock.ToolTip>
                                            <ToolTip>
                                                <TextBlock>
                                                    <Run Text="Cantidad "/>
                                                    <Run Text="total" FontWeight="Bold"/>
                                                    <Run Text=" de "/>
                                                    <Run Text="este" FontWeight="Bold"/>
                                                    <Run Text=" artículo por lote y fecha de caducidad en "/>
                                                    <Run Text="todos" FontWeight="Bold"/>
                                                    <Run Text=" los almacenes"/>
                                                </TextBlock>
                                            </ToolTip>
                                        </TextBlock.ToolTip>
                                    </TextBlock>
                                    <TextBlock Text="{Binding TotalArticuloGlobal, StringFormat=F4}" Margin="4,0,12,0"/>
                                    <TextBlock Text="Almacén:" FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}">
                                        <TextBlock.ToolTip>
                                            <ToolTip>
                                                <TextBlock>
                                                    <Run Text="Cantidad "/>
                                                    <Run Text="total" FontWeight="Bold"/>
                                                    <Run Text=" de "/>
                                                    <Run Text="este" FontWeight="Bold"/>
                                                    <Run Text=" artículo por lote y fecha de caducidad en "/>
                                                    <Run Text="este" FontWeight="Bold"/>
                                                    <Run Text=" almacén específico"/>
                                                </TextBlock>
                                            </ToolTip>
                                        </TextBlock.ToolTip>
                                    </TextBlock>
                                    <TextBlock Text="{Binding TotalArticuloAlmacen, StringFormat=F4}" Margin="4,0,0,0"/>
                                </StackPanel>
                            </StackPanel>

                            <!-- A LA DERECHA: Disponible destacado -->
                            <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="1"
                            Background="#F0F6FF"
                            CornerRadius="6"
                            Padding="12,4"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Disponible:" 
                                       FontWeight="Bold" 
                                       Foreground="{StaticResource BrushPrincipal}" 
                                       FontSize="15"
                                       Margin="0,0,4,0"/>
                                    <TextBlock Text="{Binding UnidadSaldo, StringFormat=F4}"  
                                       FontWeight="Bold" 
                                       FontSize="22"
                                       Foreground="{Binding UnidadSaldo, Converter={StaticResource NegativeValueColorConverter}}"/>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ListView.ItemTemplate>

        </ListView>



        <!-- AÑADIMOS LA FILA 4: Exportar Excel ABAJO A LA DERECHA -->
        <StackPanel Grid.Row="4"
                Orientation="Horizontal"
                HorizontalAlignment="Right"
                Margin="20,10,20,20">
            <Button Content="Exportar Excel"
            Style="{StaticResource EstiloBotonPrincipal}"
            Width="120"
            Height="30"
            Command="{Binding ExportarExcelCommand}"
            IsEnabled="{Binding CanExportExcel}"/>
            <Button Content="Imprimir etiqueta"
            Style="{StaticResource EstiloBotonPrincipal}"
            Width="140"
            Height="30"
            Margin="12,0,0,0"
            Command="{Binding ImprimirEtiquetaStockCommand}"
            IsEnabled="{Binding CanImprimirEtiqueta}"/>
        </StackPanel>
    </Grid>
</Page>
