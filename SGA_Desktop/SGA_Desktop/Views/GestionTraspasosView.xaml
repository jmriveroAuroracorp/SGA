<Page x:Class="SGA_Desktop.Views.GestionTraspasosView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:helpers="clr-namespace:SGA_Desktop.Helpers"
      Background="{StaticResource BrushFondo}">

    <Page.Resources>
        <helpers:NullToBoolConverter x:Key="NotNullToBoolConverter"/>
        <helpers:BoolToYesNoConverter x:Key="BoolToYesNoConverter"/>
        <helpers:OperarioIdANombreConverter x:Key="OperarioIdANombreConverter"/>
        <helpers:EstaAbiertoConverter x:Key="EstaAbiertoConverter"/>
        <helpers:EstaCerradoConverter x:Key="EstaCerradoConverter"/>
        <helpers:EstadoColorConverter x:Key="EstadoColorConverter"/>
        <helpers:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <helpers:EstaPendienteConverter x:Key="EstaPendienteConverter"/>
        <helpers:ZeroToCollapsedConverter x:Key="ZeroToCollapsedConverter"/>
    </Page.Resources>

    <Grid Margin="8">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*" />
            <ColumnDefinition Width="5*" />
        </Grid.ColumnDefinitions>

        <!-- 📋 Lista de traspasos -->
        <DockPanel Grid.Column="0" LastChildFill="True" Margin="0,0,8,0">
            <StackPanel Orientation="Horizontal"
                        DockPanel.Dock="Top"
                        Margin="0,0,0,8"
                        VerticalAlignment="Center">

                <Button Content="🔍 Filtros"
                        Style="{StaticResource EstiloBotonPrincipal}"
                        Command="{Binding AbrirFiltrosCommand}"
                        Width="110"
                        Margin="0,0,8,0"/>
                <Button Content="➕ Nuevo"
                        Style="{StaticResource EstiloBotonPrincipal}"
                        Command="{Binding NuevoTraspasoCommand}"
                        Width="100"
                        Margin="0,0,8,0"/>
            </StackPanel>

            <ListView ItemsSource="{Binding Traspasos}"
                      SelectedItem="{Binding TraspasoSeleccionado, Mode=TwoWay}"
                      Margin="10"
                      HorizontalContentAlignment="Stretch">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <Border CornerRadius="10"
                                BorderThickness="2"
                                Margin="4"
                                Padding="10"
                                Background="White"
                                BorderBrush="{Binding CodigoEstado, Converter={StaticResource EstadoColorConverter}}">
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.2"/>
                            </Border.Effect>
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <Ellipse Width="14" Height="14"
                                             Fill="{Binding CodigoEstado, Converter={StaticResource EstadoColorConverter}}"
                                             Margin="0,0,6,0"/>
                                    <TextBlock Text="{Binding CodigoPrincipal}" FontWeight="Bold" FontSize="15" Foreground="{StaticResource BrushPrincipal}"/>
                                    <TextBlock Text=" - " FontSize="15"/>
                                    <TextBlock Text="{Binding CodigoEstado}" FontWeight="Bold" FontSize="15" Foreground="{Binding CodigoEstado, Converter={StaticResource EstadoColorConverter}}"/>
                                </StackPanel>
                                <TextBlock Margin="0,2,0,0">
                                    <Run Text="Origen: " FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}"/>
                                    <Run Text="{Binding AlmacenOrigen}" Foreground="{StaticResource BrushGrisOscuro}"/>
                                    <Run Text=" → Destino: " FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}"/>
                                    <Run Text="{Binding AlmacenDestino}" Foreground="{StaticResource BrushGrisOscuro}"/>
                                </TextBlock>
                                <TextBlock Margin="0,2,0,0">
                                    <Run Text="Iniciado: " FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}"/>
                                    <Run Text="{Binding UsuarioInicioNombre}" Foreground="{StaticResource BrushGrisOscuro}"/>
                                    <Run Text=" el " Foreground="{StaticResource BrushPrincipal}"/>
                                    <Run Text="{Binding FechaInicio, StringFormat={}{0:dd/MM/yyyy HH:mm}}" Foreground="{StaticResource BrushGrisOscuro}"/>
                                </TextBlock>
                                <TextBlock Margin="0,2,0,0" Visibility="{Binding FechaFinalizacion, Converter={StaticResource NullToVisibilityConverter}}">
                                    <Run Text="Finalizado por: " FontWeight="Bold" Foreground="{StaticResource BrushPrincipal}"/>
                                    <Run Text="{Binding UsuarioFinalizacionNombre}" Foreground="{StaticResource BrushGrisOscuro}"/>
                                    <Run Text=" el " Foreground="{StaticResource BrushPrincipal}"/>
                                    <Run Text="{Binding FechaFinalizacion, StringFormat={}{0:dd/MM/yyyy HH:mm}}" Foreground="{StaticResource BrushGrisOscuro}"/>
                                </TextBlock>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </DockPanel>

        <!-- 📄 Detalle del traspaso -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Título con icono -->
            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,16" VerticalAlignment="Center">
                <TextBlock Text="📋" FontSize="24" Margin="0,0,8,0"/>
                <TextBlock Text="{Binding TraspasoSeleccionado.CodigoPrincipal, StringFormat=Detalle del Traspaso: {0}}"
                           Style="{StaticResource LabelStyle}" FontSize="20" VerticalAlignment="Center"/>
            </StackPanel>

            <!-- Contenido del detalle -->
            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="16">
                    <!-- Estado -->
                    <Border Background="White" CornerRadius="8" Padding="16" Margin="0,0,0,12" 
                            BorderThickness="1" BorderBrush="{Binding TraspasoSeleccionado.CodigoEstado, Converter={StaticResource EstadoColorConverter}}">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.1"/>
                        </Border.Effect>
                        <StackPanel>
                            <TextBlock Text="Estado del Traspaso" FontWeight="Bold" FontSize="16" 
                                       Foreground="{StaticResource BrushPrincipal}" Margin="0,0,0,8"/>
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <Ellipse Width="12" Height="12" 
                                         Fill="{Binding TraspasoSeleccionado.CodigoEstado, Converter={StaticResource EstadoColorConverter}}"
                                         Margin="0,0,8,0"/>
                                <TextBlock Text="{Binding TraspasoSeleccionado.CodigoEstado}" 
                                           FontWeight="Bold" FontSize="14" 
                                           Foreground="{Binding TraspasoSeleccionado.CodigoEstado, Converter={StaticResource EstadoColorConverter}}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Información del Palet -->
                    <Border Background="White" CornerRadius="8" Padding="16" Margin="0,0,0,12" 
                            BorderThickness="1" BorderBrush="{StaticResource BrushIntermedio}">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.1"/>
                        </Border.Effect>
                        <StackPanel>
                            <TextBlock Text="📦 Información del Palet" FontWeight="Bold" FontSize="16" 
                                       Foreground="{StaticResource BrushPrincipal}" Margin="0,0,0,12"/>
                            
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Código:" FontWeight="Bold" Foreground="{StaticResource BrushIntermedio}"/>
                                <TextBlock Grid.Column="1" Text="{Binding TraspasoSeleccionado.CodigoPalet}" 
                                           Foreground="{StaticResource BrushGrisOscuro}"/>
                            </Grid>
                            
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Tipo:" FontWeight="Bold" Foreground="{StaticResource BrushIntermedio}"/>
                                <TextBlock Grid.Column="1" Text="{Binding TraspasoSeleccionado.TipoTraspaso}" 
                                           Foreground="{StaticResource BrushGrisOscuro}"/>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!-- Ubicaciones -->
                    <Border Background="White" CornerRadius="8" Padding="16" Margin="0,0,0,12" 
                            BorderThickness="1" BorderBrush="{StaticResource BrushIntermedio}">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.1"/>
                        </Border.Effect>
                        <StackPanel>
                            <TextBlock Text="📍 Ubicaciones" FontWeight="Bold" FontSize="16" 
                                       Foreground="{StaticResource BrushPrincipal}" Margin="0,0,0,12"/>
                            
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Origen:" FontWeight="Bold" Foreground="{StaticResource BrushIntermedio}"/>
                                <TextBlock Grid.Column="1" Text="{Binding TraspasoSeleccionado.AlmacenOrigen}" 
                                           Foreground="{StaticResource BrushGrisOscuro}"/>
                            </Grid>
                            
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Destino:" FontWeight="Bold" Foreground="{StaticResource BrushIntermedio}"/>
                                <TextBlock Grid.Column="1" Text="{Binding TraspasoSeleccionado.AlmacenDestino}" 
                                           Foreground="{StaticResource BrushGrisOscuro}"/>
                            </Grid>
                            
                            <Grid Margin="0,0,0,8" Visibility="{Binding TraspasoSeleccionado.UbicacionDestino, Converter={StaticResource NullToVisibilityConverter}}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Ubicación:" FontWeight="Bold" Foreground="{StaticResource BrushIntermedio}"/>
                                <TextBlock Grid.Column="1" Text="{Binding TraspasoSeleccionado.UbicacionDestino}" 
                                           Foreground="{StaticResource BrushGrisOscuro}"/>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!-- Usuarios y Fechas -->
                    <Border Background="White" CornerRadius="8" Padding="16" Margin="0,0,0,12" 
                            BorderThickness="1" BorderBrush="{StaticResource BrushIntermedio}">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.1"/>
                        </Border.Effect>
                        <StackPanel>
                            <TextBlock Text="👥 Usuarios y Fechas" FontWeight="Bold" FontSize="16" 
                                       Foreground="{StaticResource BrushPrincipal}" Margin="0,0,0,12"/>
                            
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Iniciado por:" FontWeight="Bold" Foreground="{StaticResource BrushIntermedio}"/>
                                <TextBlock Grid.Column="1" Text="{Binding TraspasoSeleccionado.UsuarioInicioNombre}" 
                                           Foreground="{StaticResource BrushGrisOscuro}"/>
                            </Grid>
                            
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Fecha inicio:" FontWeight="Bold" Foreground="{StaticResource BrushIntermedio}"/>
                                <TextBlock Grid.Column="1" Text="{Binding TraspasoSeleccionado.FechaInicio, StringFormat={}{0:dd/MM/yyyy HH:mm}}" 
                                           Foreground="{StaticResource BrushGrisOscuro}"/>
                            </Grid>
                            
                            <Grid Margin="0,0,0,8" Visibility="{Binding TraspasoSeleccionado.UsuarioFinalizacionId, Converter={StaticResource NullToVisibilityConverter}}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Finalizado por:" FontWeight="Bold" Foreground="{StaticResource BrushIntermedio}"/>
                                <TextBlock Grid.Column="1" Text="{Binding TraspasoSeleccionado.UsuarioFinalizacionNombre}" 
                                           Foreground="{StaticResource BrushGrisOscuro}"/>
                            </Grid>
                            
                            <Grid Margin="0,0,0,8" Visibility="{Binding TraspasoSeleccionado.FechaFinalizacion, Converter={StaticResource NullToVisibilityConverter}}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Fecha fin:" FontWeight="Bold" Foreground="{StaticResource BrushIntermedio}"/>
                                <TextBlock Grid.Column="1" Text="{Binding TraspasoSeleccionado.FechaFinalizacion, StringFormat={}{0:dd/MM/yyyy HH:mm}}" 
                                           Foreground="{StaticResource BrushGrisOscuro}"/>
                                                         </Grid>
                         </StackPanel>
                     </Border>

                     <!-- Contenido del Palet -->
                     <Border Background="White" CornerRadius="8" Padding="16" Margin="0,0,0,12" 
                             BorderThickness="1" BorderBrush="{StaticResource BrushIntermedio}">
                         <Border.Effect>
                             <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.1"/>
                         </Border.Effect>
                         <StackPanel>
                             <TextBlock Text="📦 Contenido del Palet" FontWeight="Bold" FontSize="16" 
                                        Foreground="{StaticResource BrushPrincipal}" Margin="0,0,0,12"/>
                             
                             <TextBlock Text="{Binding TraspasoSeleccionado.LineasPalet.Count, StringFormat=Total de artículos: {0}}" 
                                        FontWeight="Bold" Foreground="{StaticResource BrushIntermedio}" Margin="0,0,0,8"/>
                             
                             <ListView ItemsSource="{Binding TraspasoSeleccionado.LineasPalet}" 
                                       MaxHeight="200" ScrollViewer.VerticalScrollBarVisibility="Auto"
                                       Background="Transparent" BorderThickness="0">
                                 <ListView.ItemTemplate>
                                     <DataTemplate>
                                         <Border Background="#f8f9fa" CornerRadius="6" Padding="12" Margin="0,0,0,8" 
                                                 BorderThickness="1" BorderBrush="#e9ecef">
                                             <Grid>
                                                 <Grid.ColumnDefinitions>
                                                     <ColumnDefinition Width="*"/>
                                                     <ColumnDefinition Width="Auto"/>
                                                 </Grid.ColumnDefinitions>
                                                 
                                                 <!-- Información del artículo -->
                                                 <StackPanel Grid.Column="0">
                                                     <TextBlock Text="{Binding CodigoArticulo}" FontWeight="Bold" 
                                                                Foreground="{StaticResource BrushPrincipal}" FontSize="14"/>
                                                     <TextBlock Text="{Binding DescripcionArticulo}" 
                                                                Foreground="{StaticResource BrushGrisOscuro}" FontSize="12" 
                                                                TextWrapping="Wrap" Margin="0,2,0,4"/>
                                                     
                                                     <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                         <TextBlock Text="Lote: " FontWeight="Bold" FontSize="11" 
                                                                    Foreground="{StaticResource BrushIntermedio}"/>
                                                         <TextBlock Text="{Binding Lote}" FontSize="11" 
                                                                    Foreground="{StaticResource BrushGrisOscuro}"/>
                                                         <TextBlock Text=" | Cad: " FontWeight="Bold" FontSize="11" 
                                                                    Foreground="{StaticResource BrushIntermedio}" Margin="8,0,0,0"/>
                                                         <TextBlock Text="{Binding FechaCaducidad, StringFormat={}{0:dd/MM/yyyy}}" FontSize="11" 
                                                                    Foreground="{StaticResource BrushGrisOscuro}"/>
                                                     </StackPanel>
                                                 </StackPanel>
                                                 
                                                 <!-- Cantidad -->
                                                 <TextBlock Grid.Column="1" Text="{Binding Cantidad}" 
                                                            FontSize="18" FontWeight="Bold" 
                                                            Foreground="{StaticResource BrushPrincipal}"
                                                            VerticalAlignment="Center" HorizontalAlignment="Right"
                                                            Margin="16,0,0,0"/>
                                             </Grid>
                                         </Border>
                                     </DataTemplate>
                                 </ListView.ItemTemplate>
                             </ListView>
                             
                         </StackPanel>
                     </Border>
                 </StackPanel>
             </ScrollViewer>

            <StackPanel Grid.Row="2"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Margin="0,8,0,0">
                <Button Content="✅ Finalizar"
                        Margin="0,0,20,0"
                        Style="{StaticResource EstiloBotonPrincipal}"
                        Command="{Binding FinalizarTraspasoCommand}"
                        IsEnabled="{Binding TraspasoSeleccionado.CodigoEstado, Converter={StaticResource EstaPendienteConverter}}" />
                <Button Content="❌ Cancelar"
                        Margin="0,0,20,0"
                        Style="{StaticResource EstiloBotonPrincipal}"
                        Command="{Binding CancelarTraspasoCommand}"
                        IsEnabled="{Binding TraspasoSeleccionado.CodigoEstado, Converter={StaticResource EstaPendienteConverter}}" />
            </StackPanel>

            <TextBlock Text="{Binding ErrorMessage}" Foreground="Red" Margin="0,4" FontWeight="Bold"/>
        </Grid>
    </Grid>
</Page>
